{% extends "shop/base.html" %}
{% load humanize %}

{% block title %}Laporan Penjualan | AF Promotion{% endblock %}

{% block content %}

<style>
  * {
    font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, sans-serif !important;
  }

  body {
    background: #f7f4f2;
  }

  .sr-page {
    max-width: 1100px;
    margin: 2.6rem auto 4rem;
    padding: 0 clamp(1rem, 4vw, 1.5rem) 2.5rem;
    color: #2C2524;
  }

  .sr-title {
    font-size: clamp(1.5rem, 2vw + 1rem, 1.8rem);
    font-weight: 700;
    color: #7A0E1A;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 0.4rem;
  }

  .sr-sub {
    font-size: 0.9rem;
    color: #8A7F7C;
    margin-bottom: 1.8rem;
  }

  /* FILTER BAR (tanggal + tombol) */
  .sr-filter-bar {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    padding: 0.9rem 1.1rem;
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.9);
    box-shadow: 0 10px 24px rgba(0, 0, 0, 0.05);
    border: 1px solid rgba(230, 220, 215, 0.9);
  }

  .sr-filter-label {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.16em;
    color: #8A7F7C;
  }

  .sr-filter-input {
    border-radius: 999px;
    border: 1px solid rgba(210, 198, 193, 0.9);
    padding: 0.32rem 0.8rem;
    font-size: 0.8rem;
    background: #FDF9F7;
    outline: none;
  }

  .sr-filter-input:focus {
    border-color: #7A0E1A;
  }

  .sr-btn-apply {
    border-radius: 999px;
    padding: 0.38rem 1rem;
    border: none;
    background: #7A0E1A;
    color: #fff;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    cursor: pointer;
    box-shadow: 0 8px 18px rgba(122, 14, 26, 0.35);
    transition: transform 0.1s ease, box-shadow 0.1s ease, background 0.1s ease;
  }

  .sr-btn-apply:hover {
    background: #A03B48;
    transform: translateY(-1px);
    box-shadow: 0 12px 24px rgba(122, 14, 26, 0.45);
  }

  .sr-btn-export {
    margin-left: auto;
    border-radius: 999px;
    padding: 0.35rem 1rem;
    border: 1px solid rgba(122, 14, 26, 0.7);
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    text-decoration: none;
    color: #7A0E1A;
    background: rgba(255, 255, 255, 0.95);
    box-shadow: 0 4px 10px rgba(122, 14, 26, 0.15);
    transition: background 0.1s ease, color 0.1s ease, box-shadow 0.1s ease, transform 0.1s ease;
    white-space: nowrap;
  }

  .sr-btn-export:hover {
    background: #7A0E1A;
    color: #fff;
    transform: translateY(-1px);
    box-shadow: 0 10px 22px rgba(122, 14, 26, 0.35);
  }

  @media (max-width: 640px) {
    .sr-filter-bar {
      padding-inline: 0.9rem;
    }
    .sr-btn-export {
      margin-left: 0;
      width: 100%;
      text-align: center;
    }
  }

  /* GRID STAT */
  .sr-stat-grid {
    display: grid;
    grid-template-columns: repeat(4, minmax(0, 1fr));
    gap: 1.1rem;
    margin-bottom: 2rem;
  }

  @media (max-width: 980px) {
    .sr-stat-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }
  @media (max-width: 640px) {
    .sr-stat-grid {
      grid-template-columns: 1fr;
    }
  }

  .sr-card {
    border-radius: 18px;
    background: radial-gradient(circle at top left, #ffffff 0%, #F4EEEB 60%, #E7DBD7 100%);
    box-shadow:
      0 12px 30px rgba(0, 0, 0, 0.06),
      inset 0 0 0 1px rgba(255, 255, 255, 0.95);
    padding: 1rem 1.1rem 1.1rem;
  }

  .sr-card-title {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.16em;
    color: #8A7F7C;
    margin-bottom: 0.5rem;
  }

  .sr-card-value {
    font-size: 1.6rem;
    font-weight: 700;
    color: #2C2524;
    word-wrap: break-word;
  }

  .sr-card-caption {
    margin-top: 0.2rem;
    font-size: 0.78rem;
    color: #A0938F;
  }

  .sr-status-list {
    list-style: none;
    padding: 0;
    margin: 0.15rem 0 0;
    font-size: 0.82rem;
  }

  .sr-status-list li {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.15rem;
  }

  .sr-status-label {
    color: #5E4F4C;
  }

  .sr-status-count {
    font-weight: 600;
    color: #7A0E1A;
  }

  hr.sr-sep {
    border: none;
    border-top: 1px solid rgba(221, 210, 206, 0.9);
    margin: 1.8rem 0 1.4rem;
  }

  /* PRODUK TERLARIS */
  .sr-section-title {
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.8rem;
    color: #2C2524;
  }

  .sr-top-products {
    list-style: none;
    padding-left: 0;
    font-size: 0.9rem;
    margin-bottom: 1.4rem;
  }

  .sr-top-products li {
    display: flex;
    justify-content: space-between;
    padding: 0.35rem 0;
    border-bottom: 1px dashed rgba(223, 212, 208, 0.9);
  }

  .sr-top-products li:last-child {
    border-bottom: none;
  }

  .sr-product-name {
    color: #3A2F2D;
  }

  .sr-product-qty {
    color: #7A0E1A;
    font-weight: 600;
  }

  /* TABEL PESANAN */
  .sr-table-wrap {
    margin-top: 0.6rem;
    border-radius: 18px;
    background: #ffffff;
    box-shadow:
      0 12px 30px rgba(0,0,0,0.06),
      inset 0 0 0 1px rgba(255,255,255,0.95);
    padding: 1.4rem 1.5rem 1.6rem;
    overflow-x: auto;                 /* penting buat HP */
    -webkit-overflow-scrolling: touch;
  }

  .sr-table {
    width: 100%;
    min-width: 720px;                 /* biar kolom nggak gepeng */
    border-collapse: collapse;
    font-size: 0.88rem;
  }

  .sr-table thead th {
    text-align: left;
    padding-bottom: 0.45rem;
    font-size: 0.78rem;
    text-transform: uppercase;
    letter-spacing: 0.14em;
    color: #8A7F7C;
    border-bottom: 1px solid rgba(219, 208, 203, 0.95);
    white-space: nowrap;
  }

  .sr-table tbody td {
    padding: 0.6rem 0 0.65rem;
    border-bottom: 1px solid rgba(238, 229, 225, 0.9);
    vertical-align: top;
  }

  .sr-table tbody tr:last-child td {
    border-bottom: none;
  }

  .sr-link-detail {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.13em;
    text-decoration: none;
    color: #7A0E1A;
    white-space: nowrap;
  }

  .sr-link-detail:hover {
    text-decoration: underline;
  }

  @media (max-width: 480px) {
    .sr-page {
      margin-top: 2rem;
    }
    .sr-table-wrap {
      padding-inline: 1rem;
    }
  }
</style>

<div class="sr-page">
  <h1 class="sr-title">Laporan Penjualan</h1>
  <p class="sr-sub">
    
  </p>

  <!-- FILTER TANGGAL + EXPORT -->
  <form method="get" class="sr-filter-bar">
    <span class="sr-filter-label">Periode</span>

    <input type="date"
           name="start"
           value="{{ start }}"
           class="sr-filter-input">

    <span style="font-size:0.8rem; color:#B0A39F;">-></span>

    <input type="date"
           name="end"
           value="{{ end }}"
           class="sr-filter-input">

    <button type="submit" class="sr-btn-apply">
      Terapkan
    </button>

    <!-- Export CSV dengan membawa parameter tanggal yg sama -->
    <a href="{% url 'shop:management_sales_report_export' %}?start={{ start }}&end={{ end }}"
       class="sr-btn-export">
      Download CSV
    </a>
  </form>

  <!-- STAT CARD -->
  <div class="sr-stat-grid">
    <div class="sr-card">
      <div class="sr-card-title">Total Pesanan</div>
      <div class="sr-card-value">{{ total_orders }}</div>
      <!-- <div class="sr-card-caption">Jumlah order pada periode ini.</div> -->
    </div>

    <div class="sr-card">
      <div class="sr-card-title">Omzet</div>
      <div class="sr-card-value">Rp {{ total_revenue|intcomma }}</div>
      <!-- <div class="sr-card-caption">Status PAID + COMPLETED.</div> -->
    </div>

    <div class="sr-card">
      <div class="sr-card-title">Rata-rata Nilai Order</div>
      <div class="sr-card-value">Rp {{ avg_order_value|intcomma }}</div>
      <!-- <div class="sr-card-caption">Total omzet dibagi jumlah order.</div> -->
    </div>

    <div class="sr-card">
      <div class="sr-card-title">Order per Status</div>
      <ul class="sr-status-list">
        {% for row in orders_per_status %}
          <li>
            <span class="sr-status-label">
              {% for code, label in status_choices.items %}
                {% if code == row.status %}
                  {{ label }}
                {% endif %}
              {% endfor %}
            </span>
            <span class="sr-status-count">{{ row.count }}</span>
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <hr class="sr-sep">

  <!-- PRODUK TERLARIS -->
  <h3 class="sr-section-title">Produk Terlaris</h3>
  {% if top_products %}
    <ul class="sr-top-products">
      {% for p in top_products %}
        <li>
          <span class="sr-product-name">{{ p.product__name }}</span>
          <span class="sr-product-qty">{{ p.qty }} pcs</span>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p style="font-size:0.9rem; color:#8A7F7C;">
      Tidak ada data produk terlaris untuk periode ini.
    </p>
  {% endif %}

  <hr class="sr-sep">

  <!-- TABEL PESANAN -->
  <h3 class="sr-section-title">Daftar Pesanan</h3>

  {% if orders %}
    <div class="sr-table-wrap">
      <table class="sr-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Tanggal</th>
            <th>Status</th>
            <th>Total</th>
            <th>Pelanggan</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for order in orders %}
            <tr>
              <td>#{{ order.id }}</td>
              <td>{{ order.created_at|date:"d M Y H:i" }}</td>
              <td>{{ order.get_status_display }}</td>
              <td>Rp {{ order.total|intcomma }}</td>
              <td>{{ order.customer.user.get_full_name|default:order.customer.user.username }}</td>
              <td>
                <a href="{% url 'shop:order_detail' order.id %}" class="sr-link-detail">
                  Detail
                </a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <p style="font-size:0.9rem; color:#8A7F7C;">
      Tidak ada order pada rentang waktu ini.
    </p>
  {% endif %}
</div>

{% endblock %}
